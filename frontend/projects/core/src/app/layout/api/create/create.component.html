<div class="mt-formtop">
  <form
    nz-form
    [nzNoColon]="true"
    [nzAutoTips]="autoTips"
    [formGroup]="validateForm"
    autocomplete="off"
  >
    <nz-form-item>
      <nz-form-label [nzSpan]="7" nzRequired>所属分组/API名称：</nz-form-label>
      <div nz-col [nzSpan]="12">
        <eo-ng-input-group [nzCompact]="true">
          <nz-form-control>
            <eo-ng-tree-select
              class="w-[202px]"
              name="header"
              required
              formControlName="group_uuid"
              nzLabelProperty="name"
              nzValueProperty="uuid"
              nzPlaceHolder="请选择"
              eoNgUserAccess="router"
              [nzDisabled]="nzDisabled"
              (disabledEdit)="disabledEdit($event)"
              nzDropdownClassName="api-tree-select"
              [nzNodes]="headerList"
              nzShowSearch
              (nzTreeClick)="nzTreeClick($event)"
            ></eo-ng-tree-select>
          </nz-form-control>
          <nz-form-control>
            <input
              class="w-[306px]"
              type="text"
              eo-ng-input
              name="name"
              formControlName="name"
              placeholder="请输入API名称"
              required
              eoNgUserAccess="router"
            />
          </nz-form-control>
        </eo-ng-input-group>
      </div>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="7">描述：</nz-form-label>
      <nz-form-control [nzSpan]="12">
        <textarea
          class="w-INPUT_LARGE"
          name="desc"
          rows="6"
          eo-ng-input
          formControlName="desc"
          placeholder="请输入"
          eoNgUserAccess="router"
        ></textarea>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="7" nzRequired>请求路径：</nz-form-label>
      <nz-form-control
        [nzSpan]="12"
        nzValidatingTip="Validating..."
        [nzErrorTip]="nameErrorTpl"
      >
        <eo-ng-input-group nzPrefix="/" class="w-INPUT_LARGE">
          <input
            style="height: unset !important"
            eo-ng-input
            name="request_path"
            required
            placeholder="请输入"
            formControlName="request_path"
            (blur)="requestPathChange()"
            eoNgUserAccess="router"
          />
        </eo-ng-input-group>
        <ng-template #nameErrorTpl let-control>
          <ng-container *ngIf="control.hasError('pattern')"
            >请求路径不支持含有 ? 的字符串</ng-container
          >
          <ng-container *ngIf="control.hasError('required')"
            >必填项</ng-container
          ></ng-template
        >
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="7" nzRequired>绑定上游服务：</nz-form-label>
      <nz-form-control [nzSpan]="12">
        <eo-ng-select
          class="w-INPUT_LARGE"
          name="service"
          required
          formControlName="service"
          [nzOptions]="serviceList"
          nzPlaceHolder="请选择"
          [nzDisabled]="nzDisabled"
        ></eo-ng-select>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item
      nz-row
      class="checkbox-group-api"
      nzSpan="19"
      [ngClass]="{ 'ant-form-item-has-error': showCheckboxGroupValid }"
    >
      <nz-form-label [nzSpan]="7" nzRequired>请求方式：</nz-form-label>
      <div nz-col [nzSpan]="12" class="min-w-INPUT_LARGE">
        <label
          eo-ng-checkbox
          [nzDisabled]="nzDisabled"
          name="allChecked"
          [(ngModel)]="allChecked"
          (ngModelChange)="updateAllChecked()"
          [ngModelOptions]="{ standalone: true }"
        >
          All
        </label>
        <eo-ng-checkbox-group
          [nzDisabled]="nzDisabled"
          name="method"
          [(ngModel)]="methodList"
          (ngModelChange)="updateSingleChecked()"
          [ngModelOptions]="{ standalone: true }"
        ></eo-ng-checkbox-group>
      </div>
    </nz-form-item>
    <div
      nz-col
      [nzOffset]="7"
      *ngIf="showCheckboxGroupValid"
      class="ant-form-item-with-help"
    >
      <div class="ant-form-item-explain">
        <div
          role="alert"
          class="ant-form-item-explain-error"
          style="margin-bottom: 20px"
        >
          必填项
        </div>
      </div>
    </div>

    <nz-form-item>
      <nz-form-label [nzSpan]="7">转发上游路径：</nz-form-label>
      <nz-form-control [nzSpan]="12">
        <input
          class="w-INPUT_LARGE"
          style="height: unset !important"
          eo-ng-input
          placeholder="请输入"
          name="proxy_path"
          eoNgUserAccess="router"
          formControlName="proxy_path"
        />
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="7" nzRequired>请求超时时间：</nz-form-label>
      <nz-form-control [nzSpan]="12" nzExtra="单位：ms，最小值：1">
        <input
          class="w-INPUT_LARGE"
          type="number"
          name="timeout"
          required
          eo-ng-input
          formControlName="timeout"
          (change)="checkTimeout()"
          placeholder="请输入"
          eoNgUserAccess="router"
        />
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="7" nzRequired>重试次数：</nz-form-label>
      <nz-form-control [nzSpan]="12">
        <input
          class="w-INPUT_LARGE"
          type="number"
          eo-ng-input
          name="retry"
          placeholder="请输入"
          formControlName="retry"
          eoNgUserAccess="router"
        />
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="7">Websocket：</nz-form-label>
      <nz-form-control [nzSpan]="12">
        <eo-ng-switch
          formControlName="enable_websocket"
          eoNgUserAccess="router"
          nzCheckedChildren="启用"
          nzUnCheckedChildren="关闭"
          [nzDisabled]="nzDisabled"
        ></eo-ng-switch>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item>
      <nz-form-label [nzSpan]="7">
        <span
          eoNgFeedbackTooltip
          nzTooltipTitle="匹配应用请求中的请求头参数、cookie、请求参数"
          nzTooltipPlacement="left"
          [nzTooltipVisible]="false"
          nzTooltipTrigger="hover"
          >高级匹配：
        </span>
      </nz-form-label>
      <nz-form-control [nzSpan]="12">
        <eo-ng-match-table
          [(matchList)]="createApiForm.match"
          [nzDisabled]="nzDisabled"
        ></eo-ng-match-table>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item class="mb-0">
      <nz-form-label [nzSpan]="7">
        <span
          eoNgFeedbackTooltip
          nzTooltipTitle="转发上游请求头新增或改写参数，或删除参数"
          nzTooltipPlacement="left"
          [nzTooltipVisible]="false"
          nzTooltipTrigger="hover"
          >转发上游请求头：
        </span>
      </nz-form-label>
      <nz-form-control [nzSpan]="12">
        <div>
          <button
            type="button"
            eoNgUserAccess="router"
            eo-ng-button
            (click)="openDrawer('proxyHeader')"
          >
            添加配置
          </button>
        </div>
        <div
          *ngIf="createApiForm.proxy_header.length > 0"
          class="mt-btnybase w-[524px]"
        >
          <eo-ng-apinto-table
            [nzTbody]="proxyHeaderTableBody"
            [nzThead]="proxyHeaderTableHeadName"
            [nzData]="createApiForm.proxy_header"
            [nzTrClick]="proxyTableClick"
            [nzMaxOperatorButton]="2"
            [nzNoScroll]="true"
          >
          </eo-ng-apinto-table>
        </div>
      </nz-form-control>
    </nz-form-item>

    <nz-form-item class="mb-0 sticky bg-white bottom-0 py-mbase">
      <nz-form-control [nzOffset]="7" [nzSpan]="12">
        <button
          eoNgUserAccess="router"
          class="ant-btn-primary"
          type="submit"
          eo-ng-button
          (click)="saveApi()"
        >
          {{ editPage ? '提交' : '保存' }}
        </button>
        <button eo-ng-button class="ml-btnybase" (click)="backToList()">
          取消
        </button>
      </nz-form-control>
    </nz-form-item>
  </form>

  <ng-template #optTypeTranslateTpl let-item="item">
    <ng-container [ngSwitch]="item.opt_type">
      <span *ngSwitchCase="'ADD'">新增或修改</span>
      <span *ngSwitchCase="'DELETE'">删除</span>
    </ng-container>
  </ng-template>
</div>
