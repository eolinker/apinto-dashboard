id: "upstream.apinto.com"
name: "service"
cname: "上游服务"
resume: "配置上游服务信息，通过API绑定，实现完整转发流程。支持IP Hash、带权轮询等负载均衡算法，合理分配上游服务压力，保证上游服务稳定性。"
version: "v1.0.6"
icon: "上游服务.png"
driver: "upstream.apinto.com"
type: 1 #0为框架模块 1为核心模块 2为内置模块 3为非内置
auto: true
front: template
navigation: "navigation.upstream"
group_id: "core_module"
define:  # 动态模块定义
  profession: service
  drivers:
    - name: http
      title: TCP
  skill: Service
  fields:
    - name: title           # 定义从响应中对应字段中获取显示值
      title: 名称
    - name: id
      title: ID
    - name: driver
      title: 驱动名称
    - name: description
      title: 描述
  render:
    http: |
      {
          "type": "object",
          "properties": {
              "scheme": {
                  "title": "请求协议",
                  "x-decorator": "FormItem",
                  "x-component": "Select",
                  "x-validator": [],
                  "x-component-props": {},
                  "x-decorator-props": {
                      "labelCol": 6,
                      "wrapperCol": 10
                  },
                  "required": true,
                  "default": "HTTP",
                  "enum": [
                      {
                          "children": [],
                          "label": "HTTP",
                          "value": "HTTP"
                      },
                      {
                          "children": [],
                          "label": "HTTPS",
                          "value": "HTTPS"
                      }
                  ],
                  "name": "scheme",
                  "x-index": 0
              },
              "balance": {
                  "title": "负载算法",
                  "x-decorator": "FormItem",
                  "x-component": "Select",
                  "x-validator": [],
                  "x-component-props": {},
                  "x-decorator-props": {
                      "labelCol": 6,
                      "wrapperCol": 10
                  },
                  "name": "balance",
                  "default": "round-robin",
                  "required": true,
                  "enum": [
                      {
                          "children": [],
                          "label": "带权轮询",
                          "value": "round-robin"
                      },
                      {
                          "children": [],
                          "label": "IP-Hash",
                          "value": "ip-hash"
                      }
                  ],
                  "x-index": 1
              },
              "use_discovery": {
                  "type": "boolean",
                  "title": "使用服务发现",
                  "x-decorator": "FormItem",
                  "x-component": "Checkbox",
                  "x-index": 2,
                  "x-decorator-props": {
                      "labelCol": 6,
                      "wrapperCol": 10
                  },
                  "name": "useDiscovery"
              },
              "discovery": {
                  "title": "服务发现",
                  "x-decorator": "FormItem",
                  "x-component": "Select",
                  "x-validator": [],
                  "x-component-props": {},
                  "x-decorator-props": {
                      "labelCol": 6,
                      "wrapperCol": 10
                  },
                  "name": "discovery",
                  "required": true,
                  "x-reactions": [
                      "{{useAsyncDataSource(getSkillData,\"Discovery\")}}",
                      {
                          "dependencies": [
                              "use_discovery"
                          ],
                          "when": "{{$deps[0] === true}}",
                          "fulfill": {
                              "state": {
                                  "visible": true
                              }
                          },
                          "otherwise": {
                              "state": {
                                  "visible": false
                              }
                          }
                      }
                  ],
                  "x-index": 3
              },
              "service": {
                  "type": "string",
                  "title": "服务名",
                  "x-decorator": "FormItem",
                  "x-component": "Input",
                  "x-validator": [],
                  "x-component-props": {},
                  "x-decorator-props": {
                      "labelCol": 6,
                      "wrapperCol": 10
                  },
                  "required": true,
                  "x-reactions": [
                      {
                          "dependencies": [
                              "use_discovery"
                          ],
                          "when": "{{$deps[0] === true}}",
                          "fulfill": {
                              "state": {
                                  "visible": true
                              }
                          },
                          "otherwise": {
                              "state": {
                                  "visible": false
                              }
                          }
                      }
                  ],
                  "x-index": 4,
                  "name": "service"
              },
              "nodes": {
                  "type": "void",
                  "title": "目标节点",
                  "x-decorator": "FormItem",
                  "x-decorator-props": {
                      "labelCol": 6,
                      "wrapperCol": 10
                  },
                  "properties": {
                      "use_variable": {
                          "type": "number",
                          "x-decorator": "FormItem",
                          "x-component": "Checkbox.Group",
                          "x-validator": [],
                          "x-component-props": {},
                          "x-decorator-props": {},
                          "enum": [
                              {
                                  "children": [],
                                  "label": "引用环境变量",
                                  "value": 1
                              }
                          ],
                          "x-index": 0
                      },
                      "variable": {
                          "type": "void",
                          "x-decorator": "FormItem",
                          "x-component": "Space",
                          "properties": {
                              "input": {
                                  "type": "string",
                                  "x-decorator": "FormItem",
                                  "x-component": "Input",
                                  "readOnly": true,
                                  "x-reactions": {
                                      "dependencies": [
                                          ".quote"
                                      ],
                                      "fulfill": {
                                          "state": {
                                              "value": "{{$deps[0]}}"
                                          }
                                      }
                                  }
                              },
                              "quote": {
                                  "type": "string",
                                  "x-decorator": "FormItem",
                                  "x-decorator-props": {},
                                  "x-component": "CustomEnvVariableComponent",
                                  "x-component-props": {}
                              }
                          },
                          "x-index": 1,
                          "x-reactions": [
                              {
                                  "dependencies": [
                                      "use_variable"
                                  ],
                                  "when": "{{$deps[0] == 1}}",
                                  "fulfill": {
                                      "state": {
                                          "visible": true
                                      }
                                  },
                                  "otherwise": {
                                      "state": {
                                          "visible": false
                                      }
                                  }
                              }
                          ]
                      },
                      "nodes": {
                          "type": "array",
                          "title": "",
                          "x-decorator": "FormItem",
                          "x-component": "ArrayItems",
                          "items": {
                              "type": "void",
                              "x-decorator": "FormItem",
                              "x-component": "Space",
                              "x-decorator-props": {
                                  "asterisk": true,
                                  "feedbackLayout": "none"
                              },
                              "properties": {
                                  "sort": {
                                      "type": "void",
                                      "x-decorator": "FormItem",
                                      "x-component": "ArrayItems.SortHandle",
                                      "x-index": 0
                                  },
                                  "addr": {
                                      "type": "string",
                                      "x-decorator": "FormItem",
                                      "x-component": "Input",
                                      "x-index": 1
                                  },
                                  "remove": {
                                      "type": "void",
                                      "x-decorator": "FormItem",
                                      "x-component": "ArrayItems.Remove",
                                      "x-index": 2
                                  }
                              }
                          },
                          "properties": {
                              "add": {
                                  "type": "void",
                                  "title": "添加节点",
                                  "x-component": "ArrayItems.Addition",
                                  "x-reactions": [
                                      {
                                          "dependencies": [
                                              "../use_variable"
                                          ],
                                          "when": "{{$deps[0] == 1}}",
                                          "fulfill": {
                                              "state": {
                                                  "visible": false
                                              }
                                          },
                                          "otherwise": {
                                              "state": {
                                                  "visible": true
                                              }
                                          }
                                      }
                                  ],
                                  "x-component-props": {}
                              }
                          },
                          "x-reactions": [
                              {
                                  "dependencies": [
                                      "use_variable"
                                  ],
                                  "when": "{{$deps[0] == 1}}",
                                  "fulfill": {
                                      "state": {
                                          "visible": false
                                      }
                                  },
                                  "otherwise": {
                                      "state": {
                                          "visible": true
                                      }
                                  }
                              }
                          ],
                          "x-validator": [],
                          "x-component-props": {},
                          "x-decorator-props": {}
                      }
                  },
                  "required": true,
                  "x-reactions": [
                      {
                          "dependencies": [
                              "use_discovery"
                          ],
                          "when": "{{$deps[0] === true}}",
                          "fulfill": {
                              "state": {
                                  "visible": false
                              }
                          },
                          "otherwise": {
                              "state": {
                                  "visible": true
                              }
                          }
                      }
                  ],
                  "x-index": 6
              },
              "timeout": {
                  "type": "number",
                  "title": "请求超时时间",
                  "x-decorator": "FormItem",
                  "x-component": "NumberPicker",
                  "x-validator": [
                      {
                          "triggerType": "onInput",
                          "min": 0
                      }
                  ],
                  "x-component-props": {},
                  "x-decorator-props": {
                      "labelCol": 6,
                      "wrapperCol": 10
                  },
                  "required": true,
                  "default": 1000,
                  "name": "timeout",
                  "description": "单位：ms，最小值：1",
                  "x-index": 7
              }
          }
      }