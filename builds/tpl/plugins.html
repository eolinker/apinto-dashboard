{{- block "header" . -}}
<link href="/css/bootstrap-table.min.css"  rel="stylesheet">
<link href="/css/bootstrap-table-reorder-rows.min.css" rel="stylesheet">
{{- end -}}
{{ block "content" .}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">全局插件</h1>
    <button type="button" id="create_btn"  class="btn btn-primary">Add</button>
</div>

<table
        id="table"
        data-toggle="table"
        data-flat="true"
        data-url="/api/{{.name}}/"
        data-reorderable-rows="true"
        data-use-row-attr-func="true"
        data-response-handler="responseHandler">
    <caption>List of {{.name}}</caption>
    <thead>
    <tr>
        {{- range $i,$t := (index .data.Title .zone)}}
        <th data-field="{{index $.data.Fields $i}}">{{ $t}}</th>
        {{- end }}
        <th data-field="operate" data-formatter="operateFormatter" data-align="center" data-events="operateEvents">操作</th>
    </tr>
    </thead>

</table>
<div class="pop_window pop_window_small" id="detail_container">
    <div class="pop_window_header">
        <span class="pop_window_title">插件配置</span>
        <button class="pop_window_button btn btn_default" id="detail_close">关闭</button>
        <br>
    </div>
    <div class="pop_window_body">
        <form id="form">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="form_name"><b>Name</b></label>
                    <input name="name" type="text" disabled class="form-control" id="form_name" value="name" required>
                </div>
                <div class="form-group col-md-6">
                    <label for="form_id"><b>ID</b></label>
                    <input name="id" type="text" disabled  class="form-control" id="form_id" value="id" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="form_status"><b>Status</b></label>
                    <select name="status" id="form_status" class="form-control" required>
                        <option value="enable">enable</option>
                        <option value="disable">disable</option>
                        <option value="global">global</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label for="form_type"><b>Type</b></label>
                    <select name="type" id="form_type" class="form-control" required>
                        <option value="router">router</option>
                        <option value="service">service</option>
                        <option value="upstream">upstream</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="clearfix">
                    <label for="form_config">
                        <b>Config</b>
                    </label>
                    <p class="nav" role="tablist" style="float:right">
                        <a class="nav-link active" id="form_config_json_tab" data-toggle="tab" href="#form_config" role="tab" aria-controls="json" aria-selected="true">JSON</a>
                        <a class="nav-link" id="form_config_ui_tab" data-toggle="tab" href="#form_config_ui" role="tab" aria-controls="ui" aria-selected="false">UI</a>
                    </p>
                </div>
                <div class="tab-content" id="form_config_content">
                    <div class="tab-pane fade show active card editor" id="form_config" role="tabpanel" aria-labelledby="form_config_json_tab"></div>
                    <div class="tab-pane fade" id="form_config_ui"  role="tabpanel" aria-labelledby="form_config_ui_tab">暂不支持</div>
                </div>
            </div>
            <div class="form-group">
                <div class="clearfix">
                    <label for="form_init_config"><b>Init Config</b></label>
                    <p class="nav" role="tablist" style="float:right">
                        <a class="nav-link active" id="form_init_config_json_tab" data-toggle="tab" href="#form_init_config" role="tab" aria-controls="json" aria-selected="true">JSON</a>
                        <a class="nav-link" id="form_init_config_ui_tab" data-toggle="tab" href="#form_init_config_ui" role="tab" aria-controls="ui" aria-selected="false">UI</a>
                    </p>
                </div>
                <div class="tab-content" id="form_init_config_content">
                    <div class="tab-pane fade show active card editor" id="form_init_config" role="tabpanel" aria-labelledby="form_init_config_json_tab"></div>
                    <div class="tab-pane fade" id="form_init_config_ui" role="tabpanel" aria-labelledby="form_init_config_ui_tab">暂不支持</div>
                </div>
            </div>
            <div class="row justify-content-between">
                <div class="col-4">
                    <button type="button" class="btn btn-outline-secondary form_cancel">取消</button>
                </div>
                <div class="col-4" style="text-align: right">
                    <button type="button" class="btn btn-primary form_submit">提交</button>
                </div>
            </div>
        </form>

    </div>


</div>
<div class="pop_window pop_window_small" id="add_container">
    <div class="pop_window_header">
        <span class="pop_window_title">新增插件</span>
        <button class="pop_window_button btn btn_default" id="add_close">关闭</button>
        <br>
    </div>
    <div class="pop_window_body">
        <form id="add_form">
            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="form_id"><b>ID</b></label>
                    <select name="id" id="add_form_id" class="form-control" required>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-12">
                    <label for="form_name"><b>Name</b></label>
                    <input name="name" type="text" class="form-control" id="add_form_name" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="form_status"><b>Status</b></label>
                    <select name="status" id="add_form_status" class="form-control" required>
                        <option value="enable">enable</option>
                        <option value="disable">disable</option>
                        <option value="global">global</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label for="form_type"><b>Type</b></label>
                    <select name="type" id="add_form_type" class="form-control" required>
                        <option value="router">router</option>
                        <option value="service">service</option>
                        <option value="upstream">upstream</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <div class="clearfix">
                    <label for="add_form_config"><b>Config</b></label>
                    <p class="nav" role="tablist" style="float:right">
                        <a class="nav-link active" id="add_form_config_json_tab" data-toggle="tab" href="#add_form_config" role="tab" aria-controls="json" aria-selected="true">JSON</a>
                        <a class="nav-link" id="add_form_config_ui_tab" data-toggle="tab" href="#add_form_config_ui" role="tab" aria-controls="ui" aria-selected="false">UI</a>
                    </p>
                </div>
                <div class="tab-content" id="add_form_config_content">
                    <div class="tab-pane fade show active card editor" id="add_form_config" role="tabpanel" aria-labelledby="add_form_config_json_tab"></div>
                    <div class="tab-pane fade" id="add_form_config_ui" role="tabpanel" aria-labelledby="add_form_config_ui_tab">暂不支持</div>
                </div>

            </div>
            <div class="form-group">
                <div class="clearfix">
                    <label for="add_form_init_config"><b>Init Config</b></label>
                    <p class="nav" role="tablist" style="float:right">
                        <a class="nav-link active" id="add_form_init_config_json_tab" data-toggle="tab" href="#add_form_init_config" role="tab" aria-controls="json" aria-selected="true">JSON</a>
                        <a class="nav-link" id="add_form_init_config_ui_tab" data-toggle="tab" href="#add_form_init_config_ui" role="tab" aria-controls="ui" aria-selected="false">UI</a>
                    </p>
                </div>
                <div class="tab-content" id="add_form_init_config_content">
                    <div class="tab-pane fade show active card editor" id="add_form_init_config" role="tabpanel" aria-labelledby="add_form_init_config_json_tab"></div>
                    <div class="tab-pane fade" id="add_form_init_config_ui" role="tabpanel" aria-labelledby="add_form_init_config_ui_tab">暂不支持</div>
                </div>
            </div>
            <div class="row justify-content-between">
                <div class="col-4">
                    <button type="button" class="btn btn-outline-secondary add_form_cancel">取消</button>
                </div>
                <div class="col-4" style="text-align: right">
                    <button type="button" class="btn btn-primary add_form_submit">提交</button>
                </div>
            </div>
        </form>
    </div>
</div>
{{end}}

{{block "script" .}}
<script src="/js/bootstrap-table.min.js"></script>
<script src="/js/jquery.tablednd.min.js"></script>
<script src="/js/bootstrap-table-reorder-rows.min.js"></script>
<script src="/js/ace/ace.js"></script>
<script src="/js/form-render.js"></script>
<script src="/js/djv.js"></script>
<script>
    /**
     * dom初始化处理
     */
    let $table = $('#table')
    let config_editor = aceEditor.InitEditor("form_config")
    let init_config_editor = aceEditor.InitEditor("form_init_config")
    let add_init_config_editor = aceEditor.InitEditor("add_form_init_config")
    let add_config_editor = aceEditor.InitEditor("add_form_config")
    /**
     * 蒙版点击处理
     */
    $("body").on('click', 'div.modal-backdrop.fade.show', function () {
        if($("#detail_container").is(":visible")){
            $("#detail_close").click()
        }
        if ($("#add_container").is(":visible")){
            $("#add_close").click()
        }
    })
    /**
     * table相关处理
     */
    window.operateEvents = {
        'click .edit': function (e, value, row, index) {
            initForm(index, row)
            $("body").append("<div class='modal-backdrop fade show'></div>").addClass("modal-open")
            $("#detail_container").show()
        },
        'click .remove': function (e, value, row, index) {
            let msg ="确认删除 "+row.name+" {{index .module.I18nName .zone}}?"
            common.confirm("删除{{index .module.I18nName .zone}}", msg, function (){
                removeRow("table", 'id', row.id)
            }, null)
        },
    }
    /**
     * table拖动事件
     */
    $(document).ready(function(){
        $table.bootstrapTable('refreshOptions', {
            onReorderRow: function (newData) {
                updateData(newData,function (res){
                    if(res.code !== 200){
                        return http.handleError(res, "更新失败")
                    }
                    common.message("更新成功", "success")
                }, function (res){
                    return http.handleError(res, "更新失败")
                })
            }
        })
    })

    /**
     * table数据初始化过滤
     * @param res
     * @returns {*}
     */
    function responseHandler(res) {
        return res.data["plugins"]
    }

    /**
     * table操作列渲染
     * @param value
     * @param row
     * @param index
     * @returns {string}
     */
    function operateFormatter(value, row, index) {
        return [
            '<a class="edit" href="javascript:void(0)" title="edit">',
            '配置',
            '</a>  ',
            '<a class="remove" href="javascript:void(0)" title="remove">',
            '删除',
            '</a>'
        ].join('')
    }

    /**
     * 更新插件全局数据
     * @param data
     * @param success
     * @param error
     */
    function updateData(data, success, error){
        dashboard.update("/api/{{.name}}/", {"plugins":data}, success, error)
    }

    /**
     * 更新table行细节
     * @param table
     * @param index
     * @param data
     */
    function updateRowDetail(table, index, data){
        $("#"+table).bootstrapTable('updateRow', {
            index: index,
            row: data
        })
    }

    /**
     * 新增新行
     * @param table
     * @param data
     */
    function addNewRow(table, data){
        let res = []
        res.push(data)
        $("#"+table).bootstrapTable('append', res)
    }

    /**
     * 移除table行
     * @param table
     * @param field
     * @param value
     */
    function removeRow(table, field, value){
        let t = $("#"+table)
        t.bootstrapTable('remove', {
            field: field,
            values: [value]
        })
        updateData(t.bootstrapTable('getData'), function (res){
            if(res.code !== 200){
                http.handleError(res, "删除失败")
                window.location.reload()
                return
            }
            common.message("删除成功", "success")
        }, function (res){
            http.handleError(res, "删除失败")
            window.location.reload()
        })
    }

    /**
     * 编辑表单初始化
     * @param index
     * @param row
     */
    function initForm(index, row) {
        $("#form").attr("data_index", index)
        $("#form_id").val(row["id"])
        $("#form_name").val(row["name"])
        $("#form_status  option[value='"+row["status"]+"'] ").attr("selected",true)
        $("#form_type  option[value='"+row["type"]+"'] ").attr("selected",true)
        // 渲染配置表单
        let config = {}
        let init_config = {}
        if(row["config"]){
            config = row["config"]
        }
        if(row["init_config"]){
            init_config = row["init_config"]
        }
        config_editor.getSession().setValue(JSON.stringify(config,null,2))
        init_config_editor.getSession().setValue(JSON.stringify(init_config, null, 2))
        getRenderInfo(row["id"].replaceAll(":","/"), function (render) {
            updateUiPane("form_config_ui", render, config)
            updateUiPane("form_init_config_ui", render, init_config)
        })
    }

    /**
     * 编辑表单关闭点击事件
     */
    $("#detail_close").click(function (){
        if($("body").hasClass("modal-open")){
            $('body').removeClass("modal-open")
            $("div.modal-backdrop.fade.show").remove()
        }
        $("#detail_container").hide(200)
    })
    $(".form_cancel").click(function (){
        if($("body").hasClass("modal-open")){
            $('body').removeClass("modal-open")
            $("div.modal-backdrop.fade.show").remove()
        }
        $("#detail_container").hide(200)
    })
    /**
     * 编辑表单提交点击事件
     */
    $(".form_submit").click(function (){
        let d = {};
        try {
            if ($("#form_config").hasClass("active")){
                d["config"] = JSON.parse(config_editor.getSession().getValue())
            }else {
                // todo json schema获取数据

            }
            // 渲染init配置表单
            if ($("#form_init_config").hasClass("active")){
                d["init_config"] = JSON.parse(init_config_editor.getSession().getValue())
            }else {
                // todo json schema获取数据

            }
        }catch(e) {
            common.message("config format is error", "danger")
            return
        }
        let t = $('#form').serializeArray();
        try {
            $.each(t, function() {
                if(this.value.length === 0){
                    throw "field " + this.name + " can not be null"
                }
                d[this.name] = this.value;
            });
        } catch(e) {
            common.message(e, "danger")
            return
        }
        updateRowDetail("table", $("#form").attr("data_index"), d)
        updateData($table.bootstrapTable('getData') ,function (res){
            if(res.code !== 200){
                return http.handleError(res, "更新失败")
            }
            common.message("更新成功", "success")
            $("#detail_close").click()
        }, function (res){
            return http.handleError(res, "更新失败")
        })
    })

    /**
     * 新增插件处理
     */
    $("#create_btn").click(function () {
        initAddForm("add_form_id", "table")
        $("body").append("<div class='modal-backdrop fade show'></div>").addClass("modal-open")
        $("#add_container").show()
    })

    /**
     * 新增表单id选项渲染
     * @param id
     * @param table
     */
    function initPluginsIDList(id, table) {
        let exist = {}
        dashboard.getExtenders(function (res) {
            if(res.code !== 200){
                return http.handleError(res, "获取扩展列表失败")
            }
            let data = res.data
            $("#"+table).bootstrapTable('getData').forEach(function (item) {
                exist[item.id] = true
            })
            let target = $("#"+id)
            target.html("")
            for (let i = 0; i < data.length; i++) {
                if (!exist[data[i].id]){
                    target.append("<option value='"+data[i].id.replaceAll(":", "/")+"'>" + data[i].id + "</option>")
                }
            }
        }, function (res) {
            return http.handleError(res, "获取扩展列表失败")
        })
    }

    /**
     * 初始化新增表单
     */
    function initAddForm(id, table) {
        initPluginsIDList(id, table)
        $("#add_form_name").val("")
        add_config_editor.getSession().setValue(JSON.stringify({}, null, 2))
        add_init_config_editor.getSession().setValue(JSON.stringify({}, null, 2))
        let pluginID = $("#"+id).val()
        if (pluginID){
            getRenderInfo(pluginID, function (render) {
                updateUiPane("add_form_config_ui", render, {})
                updateUiPane("add_form_init_config_ui", render, {})
            })
        }

    }

    /**
     * 更新ui面板
     * @param id
     * @param success
     */
    function getRenderInfo(id, success){
        dashboard.getExtenderInfo(id, function (res) {
            if(res.code !== 200){
                // return http.handleError(res, "获取extender信息失败")
                http.handleError(res, "获取extender信息失败")
            }
            // success(res.data["render"])
            success(jsonSchemaDemo)
        }, function (res){
            return http.handleError(res, "获取extender信息失败")
        })
    }

    function updateUiPane(id, render, data){
        let target = $("#"+id)
        let renderHandler = new FormRender(target, render)
        if(data){
            renderHandler.Value = data
        }
    }
    /**
     * 新增表单关闭点击事件
     */
    $("#add_close").click(function (){
        if($("body").hasClass("modal-open")){
            $('body').removeClass("modal-open")
            $("div.modal-backdrop.fade.show").remove()
        }
        $("#add_container").hide(200)
    })
    $(".add_form_cancel").click(function (){
        if($("body").hasClass("modal-open")){
            $('body').removeClass("modal-open")
            $("div.modal-backdrop.fade.show").remove()
        }
        $("#add_container").hide(200)
    })
    $(".add_form_submit").click(function (){
        let d = {};
        try {
            if ($("#add_form_config").hasClass("active")){
                d["config"] = JSON.parse(add_config_editor.getSession().getValue())
            }else {
                // todo json schema获取数据

            }
            // 渲染init配置表单
            if ($("#add_form_init_config").hasClass("active")){
                d["init_config"] = JSON.parse(add_init_config_editor.getSession().getValue())
            }else {
                // todo json schema获取数据

            }
        }catch(e) {
            common.message("config format is error", "danger")
            return
        }
        let t = $('#add_form').serializeArray();
        try {
            $.each(t, function() {
                if(this.value.length === 0){
                    throw "field " + this.name + " can not be null"
                }
                d[this.name] = this.value;
            });
        } catch(e) {
            common.message(e, "danger")
            return
        }
        if(!d["id"] || d["id"].length === 0){
            common.message("field id can not be null", "danger")
            return
        }
        let data = $table.bootstrapTable('getData')
        data.push(d)
        updateData(data ,function (res){
            if(res.code !== 200){
                return http.handleError(res, "更新失败")
            }
            addNewRow("table", d)
            common.message("更新成功", "success")
            $("#add_close").click()
        }, function (res){
            return http.handleError(res, "更新失败")
        })
    })
    $('#add_form').on('change', "select#add_form_id", function () {
        let value = $(this).val();
        getRenderInfo(value, function (render) {
            updateUiPane("add_form_config_ui", render, {})
            updateUiPane("add_form_init_config_ui", render, {})
        })
    });

</script>
{{end}}