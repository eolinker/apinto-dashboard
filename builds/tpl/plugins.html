{{- block "header" . -}}
<link href="/css/bootstrap-table.min.css"  rel="stylesheet">
<link href="/css/bootstrap-table-reorder-rows.min.css" rel="stylesheet">
<style>
    .editor {
        width: 700px;
        height: 200px;
        margin: 10px auto;
    }
</style>
{{- end -}}
{{ block "content" .}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">全局插件</h1>
    <button type="button" id="create_btn"  class="btn btn-primary">Add</button>
</div>

<table
        id="table"
        data-toggle="table"
        data-flat="true"
        data-url="/api/{{.name}}/"
        data-reorderable-rows="true"
        data-use-row-attr-func="true"
        data-response-handler="responseHandler">
    <caption>List of {{.name}}</caption>
    <thead>
    <tr>
        {{- range $i,$t := (index .data.Title .zone)}}
        <th data-field="{{index $.data.Fields $i}}">{{ $t}}</th>
        {{- end }}
        <th data-field="operate" data-formatter="operateFormatter" data-events="operateEvents">操作</th>
    </tr>
    </thead>

</table>
<div class="wrapper">
    <div class="wrapper_header">
        <span class="wrapper_title">插件配置</span>
        <button class="wrapper_button btn btn_default" >关闭</button>
        <br>
    </div>
    <div class="wrapper_body">
        <form id="form">
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="form_name"><b>Name</b></label>
                    <input name="name" type="text" disabled class="form-control" id="form_name" value="name">
                </div>
                <div class="form-group col-md-6">
                    <label for="form_id"><b>ID</b></label>
                    <input name="id" type="text" disabled  class="form-control" id="form_id" value="id">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group col-md-6">
                    <label for="form_status"><b>Status</b></label>
                    <select name="status" id="form_status" class="form-control">
                        <option value="enable">enable</option>
                        <option value="disable">disable</option>
                        <option value="global">global</option>
                    </select>
                </div>
                <div class="form-group col-md-6">
                    <label for="form_type"><b>Type</b></label>
                    <select name="type" id="form_type" class="form-control">
                        <option value="router">router</option>
                        <option value="service">service</option>
                        <option value="upstream">upstream</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="form_config"><b>Config</b></label>
                <div class="card editor" id="form_config"></div>
            </div>
            <div class="form-group">
                <label for="form_init_config"><b>Init Config</b></label>
                <div  class="card editor" id="form_init_config"></div>
            </div>
            <div class="row justify-content-between">
                <div class="col-4">
                    <button type="button" class="btn btn-outline-secondary wrapper_cancel">取消</button>
                </div>
                <div class="col-4" style="text-align: right">
                    <button type="button" class="btn btn-primary wrapper_submit">提交</button>
                </div>
            </div>
        </form>

    </div>


</div>
{{end}}

{{block "script" .}}
<script src="/js/bootstrap-table.min.js"></script>
<script src="/js/jquery.tablednd.min.js"></script>
<script src="/js/bootstrap-table-reorder-rows.min.js"></script>
<script src="/js/ace/ace.js"></script>
<script>
    let $table = $('#table')
    let config_editor = aceEditor.InitEditor("form_config")
    let init_config_editor = aceEditor.InitEditor("form_init_config")
    $(document).ready(function(){
        $table.bootstrapTable('refreshOptions', {
            onReorderRow: function (newData) {
                updateData(newData,function (res){
                    if(res.code !== 200){
                        return http.handleError(res, "更新失败")
                    }
                    common.message("更新成功", "success")
                }, function (res){
                    return http.handleError(res, "更新失败")
                })
            }
        })
    })
    function responseHandler(res) {
        return res.data["plugins"]
    }
    function operateFormatter(value, row, index) {
        return [
            '<a class="edit" href="javascript:void(0)" title="edit">',
            '配置',
            '</a>  ',
            '<a class="remove" href="javascript:void(0)" title="remove">',
            '删除',
            '</a>'
        ].join('')
    }
    function updateData(data, success, error){
        dashboard.update("/api/{{.name}}/", {
            "plugins":data
        }, success, error)
    }
    function updateRowDetail(table, index, data){
        $("#"+table).bootstrapTable('updateRow', {
            index: index,
            row: data
        })
    }
    function removeRow(table, field, value){
        let t = $("#"+table)
        t.bootstrapTable('remove', {
            field: field,
            values: [value]
        })
        updateData(t.bootstrapTable('getData'), function (res){
            if(res.code !== 200){
                http.handleError(res, "删除失败")
                window.location.reload()
                return
            }
            common.message("删除成功", "success")
        }, function (res){
            http.handleError(res, "删除失败")
            window.location.reload()
        })
    }
    window.operateEvents = {
        'click .edit': function (e, value, row, index) {
            initForm(index, row)
            $(".wrapper").show(200)
        },
        'click .remove': function (e, value, row, index) {
            let msg ="确认删除 "+row.name+" {{index .module.I18nName .zone}}?"
            common.confirm("删除{{index .module.I18nName .zone}}", msg, function (){
                removeRow("table", 'id', row.id)
            }, null)
        },
    }
    function initForm(index, row) {
        $("#form").attr("data_index", index)
        $("#form_id").val(row["id"])
        $("#form_name").val(row["name"])
        $("#form_status  option[value='"+row["status"]+"'] ").attr("selected",true)
        $("#form_type  option[value='"+row["type"]+"'] ").attr("selected",true)
        if(row["config"]){
            config_editor.getSession().setValue(JSON.stringify(row["config"],null,2))
        }else {
            config_editor.getSession().setValue(JSON.stringify({}, null, 2))
        }
        if(row["init_config"]){
            init_config_editor.getSession().setValue(JSON.stringify(row["init_config"], null, 2))
        }else {
            init_config_editor.getSession().setValue(JSON.stringify({}, null, 2))
        }
    }
    $(".wrapper_button").click(function (){
        $(".wrapper").hide(200)
    })
    $(".wrapper_cancel").click(function (){
        $(".wrapper").hide(200)
    })
    $(".wrapper_submit").click(function (){
        let d = {};
        let config = config_editor.getSession().getValue()
        let init_config = init_config_editor.getSession().getValue()
        try {
            d["config"] = JSON.parse(config)
            d["init_config"] = JSON.parse(init_config)
        } catch(e) {
            alert("config format is error")
            return
        }
        let t = $('#form').serializeArray();
        $.each(t, function() {
            d[this.name] = this.value;
        });
        updateRowDetail("table", $("#form").attr("data_index"), d)
        updateData($table.bootstrapTable('getData') ,function (res){
            if(res.code !== 200){
                return http.handleError(res, "更新失败")
            }
            common.message("更新成功", "success")
            $(".wrapper_button").click()
        }, function (res){
            return http.handleError(res, "更新失败")
        })
    })
    $("#create_btn").click(function () {
        common.message("暂未实现", "info")
    })
</script>
{{end}}