{{- block "header" . -}}
<link href="/css/bootstrap-table.min.css" rel="stylesheet"  rel="stylesheet">
{{- end -}}
{{ block "content" .data}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">路由列表</h1>
    <button type="button" id="create_btn"  class="btn btn-primary">Create</button>
</div>

<table
        id="table"
        data-toggle="table"
        data-flat="true"
        data-url="/api/{{.name}}/"
        data-response-handler="responseHandler">
    <caption>List of {{.name}}</caption>
    <thead>
    <tr>
        {{- range $i,$t := (index .data.Title .zone)}}
        <th data-field="{{index $.data.Fields $i}}">{{ $t}}</th>
        {{- end }}
        <th data-field="operate" data-formatter="operateFormatter" data-events="operateEvents">操作</th>
    </tr>
    </thead>

</table>
<div class="wrapper">
    <div class="container_header">
        <span class="wrapper_title">配置详情</span>
        <button class="wrapper_button btn btn_default" >关闭</button>
        <br>
    </div>
    <div class="card wrapper_card">
        <div class="card-header" id="wrapper_detail_header">
        </div>
        <div class="card-body wrapper_card_body">
            <p class="card-text">
                <code id="wrapper_card_content">
                </code>
            </p>

        </div>
    </div>
</div>
{{- end -}}
{{- block "script" . -}}
<script src="/js/bootstrap-table.min.js"></script>
<script>
    let $table = $('#table')
    $("#create_btn").click(function () {
        window.location.href="/{{.name}}/create"
    })
    function responseHandler(res) {
        let d = res.data
        d.forEach((item,index)=>{
            item["service"] = item["target"].substring(0, item["target"].indexOf("@"))
        })
        return d
    }
    function operateFormatter(value, row, index) {
        return [
            '<a class="edit" href="/{{.name}}/edit?name=',
            row.name,
            '&driver=',
            row.driver,
            '" title="edit">',
            '编辑',
            '</a>  ',
            '<a class="detail" href="javascript:void(0)" title="detail">',
            '详情',
            '</a>  ',
            '<a class="remove" href="javascript:void(0)" title="Remove">',
            '删除',
            '</a>  ',
            '<a class="status down" href="javascript:void(0)" title="Status">',
            '下线',
            '</a>',
        ].join('')
    }
    window.operateEvents = {
        'click .status': function (e, value, row, index) {
            let target = $(e.target)
            let msg = ""
            if(target.hasClass("up")){
                msg = "确认发布该路由吗？"
            }else{
                msg = "确认下线该路由吗？"
            }
            common.confirm("路由状态变更", msg, function (){
                dashboard.patch("/api/{{.name}}/"+row.name, {"status":!row.status}, function (res) {
                    if(res.code === 200){
                        common.message("变更成功", "danger")
                        if(target.hasClass("up")){
                            target.removeClass("up")
                            target.addClass("down")
                            target.text("下线")
                            $table.bootstrapTable('updateRow', {
                                index: index,
                                row: {
                                    status: '下线'
                                }
                            })
                        }else{
                            target.removeClass("down")
                            target.addClass("up")
                            target.text("发布")
                            $table.bootstrapTable('updateRow', {
                                index: index,
                                row: {
                                    status: '发布'
                                }
                            })
                        }
                        return
                    }
                    http.handleError(res, "变更失败")
                }, function (res) {
                    http.handleError(res, "变更失败")
                })
            })
        },
        'click .remove': function (e, value, row, index) {
            let msg ="确认删除 "+row.name+" {{index .module.I18nName .zone}}?"
            common.confirm("删除{{index .module.I18nName .zone}}", msg, function (){
                dashboard.delete( "/api/{{.name}}/"+row.name, function (res) {
                    if(res.code === 200){
                        common.message("删除成功", "danger")
                        $table.bootstrapTable('remove', {
                            field: 'id',
                            values: [row.id]
                        })
                        return
                    }
                    http.handleError(res, "删除失败")
                }, function (res) {
                    http.handleError(res, "删除失败")
                })
            }, null)
        },
        'click .detail': function (e, value, row, index) {
            $("#wrapper_detail_header").text(row.name)
            dashboard.get("/api/{{.name}}/"+row.name, function (res) {
                if(res.code === 200){
                    $("#wrapper_card_content").text(JSON.stringify(res.data))
                    $(".wrapper").show(200)
                    return
                }
                http.handleError(res, "获取详情失败")
            }, function (res) {
                http.handleError(res, "获取详情失败")
            })
        }
    }
    $(".wrapper_button").click(function (){
        $(".wrapper").hide(200)
        $("#wrapper_card_content").text("")
    })

</script>
{{- end -}}