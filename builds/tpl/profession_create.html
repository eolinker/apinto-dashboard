{{ block "content" .data}}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">新建{{index .module.I18nName .zone}}</h1>
</div>
<div class="select_content input-group mb-3">
    <div class="input-group-prepend">
        <label class="input-group-text" for="drivers">Drivers</label>
    </div>
    <select class="custom-select" id="drivers">
    </select>
</div>
<div id="form"></div>
<div id="form_button" class="row justify-content-between" style="display: none">
    <div class="col-4">
        <button type="button" class="btn btn-outline-secondary form_reset">重置</button>
    </div>
    <div class="col-4" style="text-align: right">
        <button type="button" class="btn btn-primary form_submit">提交</button>
    </div>
</div>
{{end}}
{{- block "script" . -}}
<script src="/js/form-render.js"></script>
<script src="/js/djv.js"></script>
<script>
    let ui_pane = null
    initDrivers("drivers", "/profession/{{.name}}/")
    $('.select_content').on('change', "select#drivers", function () {
        getDriverInfo($(this).val(), function (render) {
            ui_pane = updateUiPane("form", render)
            let btn = "#form_button"
            if (!$(btn).is(":visible")){
                $(btn).show()
            }
        })
    });
    $("#form_button").on("click", "button.form_reset", function () {
        resetBtn()
    }).on("click", "button.form_submit", function () {
        submitBtn()
    })
    function initDrivers(id, url){
        dashboard.get(url,function (res) {
            if(res.code !== 200){
                return http.handleError(res, "获取driver列表失败")
            }
            let data = res.data["drivers"]
            let target = $("#"+id)
            target.empty()
            for (let i = 0; i < data.length; i++) {
                if(i===0){
                    target.append("<option value='"+data[i].name+"' selected>" + data[i].name + "</option>")
                }else {
                    target.append("<option value='"+data[i].name+"'>" + data[i].name + "</option>")
                }
            }
            getDriverInfo(target.val(), function (render) {
                ui_pane = updateUiPane("form", render)
                let btn = "#form_button"
                if (!$(btn).is(":visible")){
                    $(btn).show()
                }

            })
        },function (res) {
            return http.handleError(res, "获取driver列表失败")
        })
    }
    /**
     * 更新ui面板
     * @param name
     * @param success
     */
    function getDriverInfo(name, success){
        dashboard.get("/profession/{{.name}}/"+name, function (res) {
            if(res.code !== 200){
                return http.handleError(res, "获取driver信息失败")
            }
            success(res.data["render"])
        }, function (res) {
            return http.handleError(res, "获取driver信息失败")
        })
    }

    function updateUiPane(id, render){
        return new FormRender($("#"+id), render)
    }
    function resetBtn(){
        if(ui_pane){
            ui_pane.Value = {}
        }
    }
    function submitBtn(){
        if(ui_pane && ui_pane.check()){
            dashboard.create("/api/{{.name}}/", ui_pane.Value, function (res){
                if(res.code !== 200){
                    http.handleError(res, "新增失败")
                    return
                }
                common.message("新增成功", "success")
                window.location.back()
            }, function (res){
                http.handleError(res, "新增失败")
            })
        }else {
            common.message("config format error", "danger")
        }
    }
</script>

{{- end -}}